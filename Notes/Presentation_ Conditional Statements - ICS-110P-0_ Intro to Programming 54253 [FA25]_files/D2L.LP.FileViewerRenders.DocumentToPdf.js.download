D2L.LP.DocumentViewers.FileViewerRenderers={};D2L.LP.DocumentViewers.FileViewerRenderers.PDFjsToolbar=D2L.Class.extend({Construct:function(id){this.id=id;arguments.callee.$.Construct.call(this);},InsertTool:function(position,tool){let toolbar=getFileViewerRenderedPDF().contents().find('#'+this.id);let children=toolbar.children();if(position>=children.length){toolbar.appendChild(tool);return;}if(position===0){toolbar.prepend(tool);return;}},GetTool:function(toolName){let tool=getFileViewerRenderedPDF().contents().find('#'+this.id+' #'+toolName);return tool.length?tool[0]:null;}});D2L.LP.DocumentViewers.FileViewerRenderers.PdfRenderer_PdfJs={Init:function(node){let content=$(node);let renderedPdf=$('<iframe class="d2l-fileviewer-rendered-pdf" scrolling="no" seamless="seamless"/>').css('width','100%').data('d2l_loaded',false);let isAlwaysFullyExpanded=content.attr('data-is-always-fully-expanded')==='1';if(isAlwaysFullyExpanded){renderedPdf.addClass('d2l-fileviewer-rendered-pdf-dialog');}let maxHeight=content.attr('data-max-height');if(maxHeight){renderedPdf.css('max-height',maxHeight);}let printDownload=document.getElementsByClassName('d2l-popup-printdownload');let resize=function(){let contentHeight=$(window).height();if(printDownload&&printDownload[0]){let rectPrintDownload=D2L.LP.Web.UI.Html.Dom.GetBoundingRect(printDownload[0]);contentHeight-=rectPrintDownload.height;}contentHeight-=1;renderedPdf.height(contentHeight);D2L.LP.Web.UI.Desktop.Controls.FileViewer.OnPluginLoad(renderedPdf,contentHeight);};let onLoad=function(event){let target=$(event.target);target.data('d2l_loaded',true);target[0].ViewerToolbars={Left:new D2L.LP.DocumentViewers.FileViewerRenderers.PDFjsToolbar("toolbarViewerLeft"),Right:new D2L.LP.DocumentViewers.FileViewerRenderers.PDFjsToolbar("toolbarViewerRight")};fixLtiCmsCustomization();resize();let pdfFileLocation=getFileViewerPDFJS().attr('data-location');let d2lOnLoad=D2L.LP.DocumentViewers.FileViewerRenderers.PdfRenderer_PdfJs.GetOnLoad(node);d2lOnLoad.Trigger(target,pdfFileLocation);};$(window).resize(resize);renderedPdf.appendTo(content);renderedPdf.on('load',onLoad).attr({src:D2L.LP.DocumentViewers.FileViewerRenderers.PdfRenderer_PdfJs.GenerateLocation(content,isAlwaysFullyExpanded),title:content.attr('data-title')});},GetOnLoad:function(node){return node.d2l_onLoad?node.d2l_onLoad:node.d2l_onLoad=new D2L.LP.Web.UI.Events.Event();},GenerateLocation:function(node,isAlwaysFullyExpanded){let location=D2L.LP.Web.UI.Html.JavaScript.UrlEncode(node.attr('data-location'));let culture=D2L.LP.Web.UI.Html.JavaScript.UrlEncode(node.attr('data-culture'));let contentHeight=$(window).height();let containerClass=isAlwaysFullyExpanded?'d2l-fileviewer-rendered-pdf-dialog':'d2l-fileviewer-rendered-pdf';let viewerPath='pdfjs-d2l-dist/web/viewer.html';return"/d2l/common/assets/".concat(viewerPath,"?file=").concat(location,"&lang=").concat(culture,"&container=").concat(containerClass,"&fullscreen=d2l-fileviewer-rendered-pdf-dialog&height=").concat(contentHeight,"#0");},SetLocation:function(id,location){let pdfRenderer=getFileViewerPDFJS();let view=pdfRenderer.attr('data-location',location.GetUrl());let newUrl=D2L.LP.DocumentViewers.FileViewerRenderers.PdfRenderer_PdfJs.GenerateLocation(view,false);getFileViewerRenderedPDF()[0].contentWindow.location.replace(newUrl);}};function fixLtiCmsCustomization(){let renderedPdf=getFileViewerRenderedPDF();if(!renderedPdf.length)return;let contents=renderedPdf.contents();if(!contents.length)return;let head=contents.find("head");fixMobileView(head);let pdfjs=getFileViewerPDFJS();if(!pdfjs.length)return;setFullscreenButtonVisibility(pdfjs.attr('data-is-fullscreen-button-hidden'),contents);if(pdfjs.attr('data-pdf-download-flag')==="True"){let isDownloadEnabled=pdfjs.attr('data-is-download-enabled');fixDownloadButton(isDownloadEnabled,head,contents);}}function fixMobileView(head){if(head.length){$(head).append("\n        <style type=\"text/css\">\n            #mainContainer {    min-width: 200px;}\n            @media all and (max-width: 600px) {    html[dir='ltr'] .innerCenter {        right: -8%;    }}\n            @media all and (max-width: 600px) {    html[dir='rtl'] .innerCenter {        left: -8%;    }}\n            @media all and (max-width: 465px) {    html[dir='ltr'] .innerCenter {        right: 14%;    }}\n            @media all and (max-width: 465px) {    html[dir='rtl'] .innerCenter {        left: 14%;    }}\n            @media all and (max-width: 369px) {    html[dir='ltr'] .innerCenter {        right: 18%;    }}\n            @media all and (max-width: 369px) {    html[dir='rtl'] .innerCenter {        left: 18%;    }}\n            @media all and (max-width: 369px) {    html[dir='ltr'] #previous {        position: absolute;    }    html[dir='ltr'] #next {        position: absolute;    }}\n            @media all and (max-width: 369px) {    html[dir='rtl'] #previous {        position: absolute;    }    html[dir='rtl'] #next {        position: absolute;    }}\n            @media all and (max-width: 369px) {    html[dir='ltr'] #previous {        left: -1000px;    }    html[dir='ltr'] #next {        left: -1000px;    }}\n            @media all and (max-width: 369px) {    html[dir='rtl'] #previous {        right: -1000px;    }    html[dir='rtl'] #next {        right: -1000px;    }}\n        </style>");}}function fixDownloadButton(isDownloadEnabled,head,contents){if(isDownloadEnabled==='1'){let downloadButton=contents.find('#download');if(head.length&&downloadButton.length){$(head).append('<style type="text/css">.toolbarButton.download::before {  content: url(images/toolbarButton-download.png);}@media screen and (min-resolution: 2dppx) {    .toolbarButton.download::before,    .secondaryToolbarButton.download::before {        content: url(images/toolbarButton-download@2x.png);    }}</style>');let downloadButtonAsJqueryObject=$(downloadButton);downloadButtonAsJqueryObject.removeClass().addClass('toolbarButton download visible');downloadButtonAsJqueryObject.attr('style','display: inline-block !important');downloadButtonAsJqueryObject.attr('tabindex',18);}let body=contents.find("body");if(body.length){$(body).append('<style type="text/css">a {    cursor: pointer;}</style>');}}}function setFullscreenButtonVisibility(isFullscreenButtonHidden,contents){if(isFullscreenButtonHidden==='1'){let fullscreenMode=contents.find('#fullscreenMode');if(fullscreenMode.length){$(fullscreenMode).removeClass().addClass('hidden');}}}function getFileViewerRenderedPDF(){return $('.d2l-fileviewer-rendered-pdf');}function getFileViewerPDFJS(){return $('.d2l-fileviewer-pdf-pdfjs');}D2L.LP.Web.UI.Html.Dom.AddClassInitializer('d2l-documentToPdfViewer',function(node){D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView.Init(node);});D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView={Init:function(node){if(node==null){return;}var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var id=node.getAttribute('id');var mode=node.getAttribute('data-d2l-viewmode');var minHeight=$(node).attr('data-d2l-minHeight');if(minHeight){$(node).css('min-height',minHeight+'px');}var documentData;if(D2L.LP.Web.UI.ObjectRepository.HasKey(id)){documentData=D2L.LP.Web.UI.ObjectRepository.Get(id,'documentData');documentData=D2L.LP.Web.Serialization.Json.Deserialize(documentData);}me.ApplyCssStyles(node);var pdfJsView=$('.d2l-fileviewer-pdf-pdfjs',node)[0];var pdfJsOnLoadEvent=D2L.LP.DocumentViewers.FileViewerRenderers.PdfRenderer_PdfJs.GetOnLoad(pdfJsView);pdfJsOnLoadEvent.AddListener(function(pdfJsIframe,pdfFileLocation){me.OnPdfJsLoadHandler(documentData,pdfJsIframe,pdfFileLocation,node);});me.GetIFrameByMode('text',node).on('load',function(){me.OnTextIFrameLoadHandler(node);});var location=documentData.documentConversionRequestRoute;me.LoadView(node,mode,location);if($(".d2l-fileviewer[data-viewmode='ScaleWithViewport']").length){$('.d2l-iframe-loading-container',node).height(me.GetContentViewportHeight());}$(window).resize(me.Resize);setTimeout(me.Resize,300);},ApplyCssStyles:function(node){$('.d2l-dialog-padding').css('padding',0);$('.d2l-dialog-body').css('overflow','hidden');$('.d2l-fileviewer').css('overflow','hidden');$('.d2l-dialog-footer-container').css('box-shadow','none');$('.d2l-iframe-loading-container',node).css('opacity',0);},GetContentViewportHeight:function(){$('.d2l-documentToPdfViewer-text iframe').height(0);var dialogBodyHeight=$('.d2l-dialog-body').height()||0;var resizeTargetHeight=dialogBodyHeight>0?dialogBodyHeight:$(window).height()||0;var toolsHeight=$('.d2l-documentToPdfViewer-tools').height()||0;return resizeTargetHeight-toolsHeight;},Resize:function(){var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var viewportHeight=me.GetContentViewportHeight();$('.d2l-fileviewer-text').height(viewportHeight);$('.d2l-documentToPdfViewer-text iframe').attr('data-default-height',viewportHeight).height(viewportHeight);},SetMode:function(node,mode){var textView=$('.d2l-documentToPdfViewer-text',node)[0];var renderView=$('.d2l-documentToPdfViewer-render',node)[0];D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(textView,mode==='render'?false:true);D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(renderView,mode==='text'?false:true);if(mode==='text'){D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView.Resize();}},UpdateModeState:function(viewerId,mode,saveViewModeRoute,getConversionByRequestIdRoute){var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var node=D2L.LP.Web.UI.Html.Dom.GetElementById(viewerId);var currentMode=node.getAttribute('data-d2l-viewmode');me.HideCurrentFrame(node,currentMode);me.SetLoadingMessageDisplay(true,node);me.SendToRpc(saveViewModeRoute).then(function(){me.LoadView(node,mode,getConversionByRequestIdRoute);node.setAttribute('data-d2l-viewmode',mode);},function(){me.SetLoadingMessageDisplay(false,node);});},RetryRequest:function(action,interval){return new Promise(function(resolve,reject){function fn(){action().then(function(data){if(data.status==="Complete"){resolve(data);}else if(data.status==="Pending"||data.status==="InProgress"||data.status==="NotFound"){setTimeout(function(){fn();},interval);}else{reject(data);}},function(e){reject(e);});};fn();});},LoadView:function(node,mode,getConversionByRequestIdRoute){var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var pollInterval=5000;var progressWasShown;me.SetLoadingMessageDisplay(true,node);if(!me.IsFrameInitialized(mode,me.GetIFrameByMode(mode,node))){var downloadFunction;var isInProgressFunction=setTimeout(function(){progressWasShown=true;me.SetIsInProgressDialogDisplay(true,node);if($('.d2l-documentToPdfViewer-download',node).length){downloadFunction=setTimeout(function(){me.SetIsInProgressDialogDisplay(false,node);me.SetDownloadDialogDisplay(true,node);},20000);}},8000);function catchFn(){clearTimeout(isInProgressFunction);clearTimeout(downloadFunction);me.SetIsInProgressDialogDisplay(false,node);me.SetDownloadDialogDisplay(false,node);me.SetLoadingMessageDisplay(false,node);var errorDiv=$('.d2l-documentToPdfViewer-error',node);me.AriaMessage(errorDiv.find('a').text());D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(errorDiv[0],true);}me.RetryRequest(function(){return me.SendToRpc(getConversionByRequestIdRoute);},pollInterval).then(function(data){if(data.status==="Complete"){me.SetLocation(mode,node,new D2L.LP.Web.Http.UrlLocation(data.location));}clearTimeout(isInProgressFunction);clearTimeout(downloadFunction);me.SetIsInProgressDialogDisplay(false,node);me.SetDownloadDialogDisplay(false,node);if(progressWasShown){var processingIsCompleteMsg=node.getAttribute('data-d2l-processingIsComplete');me.AriaMessage(processingIsCompleteMsg,node);}},catchFn);return;}if(me.IsFrameLoaded(mode,node)){me.SetMode(node,mode);me.SetIsInProgressDialogDisplay(false,node);me.SetDownloadDialogDisplay(false,node);me.SetLoadingMessageDisplay(false,node);return;}},IsFrameInitialized:function(mode,iframe){var location=mode==='render'?$('.d2l-fileviewer-pdf-pdfjs').attr('data-location'):iframe.attr('src');return!!location;},IsFrameLoaded:function(mode,parent){var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var iframe=me.GetIFrameByMode(mode,parent);if(iframe.data('is_frame_loaded')){return true;}if(iframe.length&&iframe[0].m_loaded){return true;}return false;},GetIFrameByMode:function(mode,parent){var iframeClass=mode==='render'?'.d2l-fileviewer-rendered-pdf':'.d2l-fileviewer-text iframe';return $(iframeClass,parent);},HideCurrentFrame:function(node,mode){if(mode==='render'){var renderView=$('.d2l-documentToPdfViewer-render',node)[0];D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(renderView,false);}if(mode==='text'){var textView=$('.d2l-documentToPdfViewer-text',node)[0];D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(textView,false);}},SetLocation:function(mode,node,location){var iframe=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView.GetIFrameByMode(mode,node);var setLocation=mode==='render'?D2L.LP.DocumentViewers.FileViewerRenderers.PdfRenderer_PdfJs.SetLocation:D2L.LP.Web.UI.Desktop.Controls.IFrame.SetLocation;setLocation(new D2L.LP.Web.UI.Html.AbsoluteHtmlId(iframe.attr('id')),location);},DownloadDocument:function(downloadUrl,httpMethod){if(!downloadUrl){return;}if(!httpMethod){httpMethod='post';}var frm=document.createElement("form");frm.target="_top";frm.action=downloadUrl;frm.method=httpMethod;var hidden=document.createElement('input');hidden.type='hidden';hidden.name=D2L.LP.Web.Authentication.Xsrf.GetXsrfTokenParameterName();hidden.value=D2L.LP.Web.Authentication.Xsrf.GetXsrfToken();frm.appendChild(hidden);document.body.appendChild(frm);frm.submit();D2L.LP.Web.UI.Html.Dom.DispatchEvent('DocumentToPdfDownload',document);},SendToRpc:function(location){return new Promise(function(resolve,reject){var xsrfToken=D2L.LP.Web.Authentication.Xsrf.GetXsrfToken();$.ajax({url:location,method:"POST",dataType:'json',beforeSend:function(xhr){xhr.setRequestHeader('X-Csrf-Token',xsrfToken);},success:resolve,error:reject});});},ToggleFullscreen:function(id){var node=D2L.LP.Web.UI.Html.Dom.GetElementById(id);var body=window.parent.document.body;if(node.d2l_isFullscreen){node.d2l_isFullscreen=false;$('.d2l-documentToPdfViewer').removeClass('d2l-documentToPdfViewer-fullscreen');$('.d2l-documentToPdfViewer').addClass('d2l-documentToPdfViewer-inline');body.style.overflow=node.getAttribute('data-d2l-body-overflow');}else{node.d2l_isFullscreen=true;$('.d2l-documentToPdfViewer').addClass('d2l-documentToPdfViewer-fullscreen');$('.d2l-documentToPdfViewer').removeClass('d2l-documentToPdfViewer-inline');node.setAttribute('data-d2l-body-overflow',body.style.overflow);body.style.overflow='hidden';}},OnPdfJsLoadHandler:function(documentData,pdf,pdfFileLocation,node){var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var rightToolBar=pdf[0].ViewerToolbars.Right;var originalFullscreenMode=rightToolBar.GetTool('fullscreenMode');var isDialogStyle=node.getAttribute('data-d2l-isDialogStyle')==='1';if(isDialogStyle){originalFullscreenMode.style.display='none';}else{var newFullscreenMode=originalFullscreenMode.cloneNode(true);originalFullscreenMode.parentNode.replaceChild(newFullscreenMode,originalFullscreenMode);newFullscreenMode.addEventListener('click',function(){me.ToggleFullscreen(node.getAttribute('id'));});}if(!pdfFileLocation){return;}pdf.data('is_frame_loaded',true);me.SetMode(node,'render');me.SetLoadingMessageDisplay(false,node);var switchToTextModeButton=$('#'+documentData.pdfViewerButtonId);rightToolBar.InsertTool(0,switchToTextModeButton);},OnTextIFrameLoadHandler:function(node){var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var iframe=me.GetIFrameByMode('text',node);iframe.data('is_frame_loaded',true);me.SetMode(node,'text');me.SetLoadingMessageDisplay(false,node);},AriaMessage:function(message,parent){if(!message){return;}var $msgDiv=$('<div class="d2l-documentToPdfViewer-aria-message d2l-offscreen" role="alert" aria-live="assertive"></div>').append(message);var $parent=$('.d2l-documentToPdfViewer-aria-log',parent);$parent.empty();$parent.append($msgDiv);},SetLoadingMessageDisplay:function(isDisplayed,parent){var errorView=$('.d2l-documentToPdfViewer-error',parent)[0];D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(errorView,false);var viewAsTextView=$('.d2l-viewMode-button-view-as-text',errorView)[0];var viewAsPageView=$('.d2l-viewMode-button-view-as-page',errorView)[0];var mode=parent.getAttribute('data-d2l-viewmode');if(mode==='text'){D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(viewAsTextView,false);D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(viewAsPageView,true);}else{D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(viewAsTextView,true);D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(viewAsPageView,false);}var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;var loadingView=$('.d2l-documentToPdfViewer-loading-overlay',parent);if(isDisplayed&&!loadingView.data('is-loading-in-progress')){var message=loadingView.find('a').text();me.AriaMessage(message,parent);}if(!isDisplayed&&loadingView.data('is-loading-in-progress')){var loadingIsCompleteMsg=parent.getAttribute('data-d2l-loadingIsComplete');me.AriaMessage(loadingIsCompleteMsg,parent);}me.SetAriaBusy(isDisplayed);loadingView.data('is-loading-in-progress',isDisplayed);D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(loadingView[0],isDisplayed);},SetAriaBusy:function(isBusy){$('.d2l-documentToPdfViewer-viewer').attr('aria-busy',isBusy);},SetDownloadDialogDisplay:function(isDisplayed,parent){var download=$('.d2l-documentToPdfViewer-download',parent);if(!download.length){return;}var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;if(isDisplayed){var message=download.find('.d2l-documentToPdfViewer-downloadMessage a').text();me.AriaMessage(message,parent);setTimeout(function(){$('.d2l-documentToPdfViewer-downloadButton button',parent).focus();},100);}D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(download[0],isDisplayed);},SetIsInProgressDialogDisplay:function(isDisplayed,parent){var container=$('.d2l-documentToPdfViewer-isInProgress',parent);var me=D2L.LP.DocumentViewers.FileViewerRenderers.DocumentToPdfView;if(isDisplayed){var message=container.find('.d2l-documentToPdfViewer-isInProgressMessage a').text();me.AriaMessage(message,parent);}D2L.LP.Web.UI.Html.Dom.SetIsDisplayedNode(container[0],isDisplayed);}};